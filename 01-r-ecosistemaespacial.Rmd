---
title: "El ecosistema espacial de R"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparativos

## Carga de paquetes

```{r message = FALSE}
library(sf)
library(rgdal)
library(raster)
library(ggplot2)
library(leaflet)
library(dplyr)
```

## Conjuntos de datos utilizados

- [Provincias de Costa Rica](https://github.com/gf0604-procesamientodatosgeograficos/2021i-datos/blob/main/ign/delimitacion-territorial-administrativa/cr_provincias_simp_wgs84.geojson)
- [Registros de presencia de Leopardus pardalis (manigordo) en Costa Rica](https://github.com/gf0604-procesamientodatosgeograficos/2021i-datos/blob/main/gbif/leopardus_pardalis-cr-registros.csv)

# Introducción
La comunidad de programadores de R ha desarrollado un conjunto de paquetes para el manejo de datos geoespaciales, tanto en formatos vectoriales como raster. Algunos de los principales de estos paquetes son:

* El paquete [sf](https://r-spatial.github.io/sf/) de R. Ofrece un conjunto de funciones para el manejo de datos vectoriales, de acuerdo con el estándar [Simple Features](https://www.ogc.org/standards/sfa).

* El paquete [raster](https://rspatial.org/raster/spatial/8-rastermanip.html) de R. Implementa un conjunto de funciones para el manejo de datos raster.

* El paquete [Leaflet para R](https://rstudio.github.io/leaflet/). Es una implementación en R de la biblioteca [Leaflet para el lenguaje JavaScript](https://leafletjs.com/) para la programación de mapas interactivos en páginas web.

Algunos paquetes de graficación, como [ggplot2](https://ggplot2.tidyverse.org/), también cuentan con algunas capacidades para procesamiento de datos geoespaciales.

# Datos vectoriales

### El modelo vectorial
El modelo vectorial de datos está basado en puntos localizados en un [sistema de referencia de coordenadas (CRS)](https://en.wikipedia.org/wiki/Spatial_reference_system). Los puntos individuales pueden representar objetos independientes (ej. la localización de un poste eléctrico o de una cabina telefónica) o pueden también agruparse para formar geometrías más complejas como líneas o polígonos. Por lo general, los puntos tienen solo dos dimensiones (x, y), a las que se les puede agregar una tercera dimensión _z_, usualmente correspondiente a la altitud sobre el nivel del mar.

### El estándar _Simple Features_
[_Simple Features_](https://www.ogc.org/standards/sfa) (o _Simple Feature Access_) es un estándar abierto de la [Organización Internacional de Estandarización (ISO)](https://iso.org/) y del [_Open Geospatial Consortium_ (OGC)](https://www.ogc.org/) que especifica un modelo común de almacenamiento y acceso para geometrías de dos dimensiones (líneas, polígonos, multilíneas, multipolígonos, etc.). El estándar es implementado por muchas bibliotecas y bases de datos geoespaciales como [sf](https://cran.r-project.org/web/packages/sf/index.html), [GDAL](https://gdal.org/), [PostgreSQL/PostGIS](https://en.wikipedia.org/wiki/PostGIS), [SQLite/SpatiaLite](https://www.gaia-gis.it/fossil/libspatialite/), [Oracle Spatial](https://www.oracle.com/database/technologies/spatialandgraph.html) y [Microsoft SQL Server](https://www.microsoft.com/en-us/sql-server/), entre muchas otras.

La especificación define 17 tipos de geometrías, de las cuales siete son las más comúnmente utilizadas. Estas últimas se muestran en la figura 1.

![**Figura 1**. Tipos de geometrías de Simple Features más usadas. Imagen de Robin Lovelace et al. (https://geocompr.robinlovelace.net/spatial-class.html#vector-data)](img/sf_types.png)

### El paquete sf
El paquete [sf](https://r-spatial.github.io/sf/) (de _Simple Features_) de R implementa los modelos de datos de las geometrías de tipo vectorial: puntos, líneas, polígonos, sus versiones múltiples y las colecciones de geometrías. Está basado en bibliotecas de sofware ampliamente utilizadas en aplicaciones geoespaciales:

* **GDAL**: [Geospatial Data Abstraction Library (GDAL)](https://gdal.org/) es una biblioteca para leer y escribir datos geoespaciales en varios formatos [raster](https://gdal.org/drivers/raster/) y [vectoriales](https://gdal.org/drivers/vector/). Implementa un único [modelo abstracto de datos raster](https://gdal.org/user/raster_data_model.html) y un único [modelo abstracto de datos vectoriales](https://gdal.org/user/vector_data_model.html), lo que permite programar aplicaciones geoespaciales sin tener que ocuparse de las particularidades de cada formato que se utilice (GeoTIFF, NetCDF, ESRI Shapefile, GeoJSON, etc.). A pesar de que GDAL está programada en C/C++, cuenta con una interfaz de programación de aplicaciones (API) para varios lenguajes de programación, incluyendo [C](https://gdal.org/api/index.html#c-api), [C++](https://gdal.org/api/index.html#id3), [Python](https://gdal.org/python/index.html) y [Java](https://gdal.org/java/overview-summary.html). Además, ofrece un conjunto de [utilitarios de línea de comandos](https://gdal.org/programs/) cuyas [distribuciones binarias](https://gdal.org/download.html#binaries) están disponibles para varios sistemas operativos, incluyendo Windows, macOS y Linux.
* **GEOS**: [Geometry Engine, Open Source (GEOS)](https://trac.osgeo.org/geos) es una implmentación en C++ de la biblioteca [JTS Topology Suite](http://www.tsusiatsoftware.net/jts/main.html) (desarrollada en Java) y que implementa un conjunto de operaciones y predicados geoespaciales (ej. unión, intersección, distancia, área).
* **PROJ**: [PROJ](https://proj.org/) es una biblioteca que transforma coordenadas entre diferentes CRS, incluyendo tanto proyecciones cartográficas como transformaciones geodésicas.

sf provee acceso, desde un mismo paquete de R, a la funcionalidad de estas tres bibliotecas, proporcionando así una interfaz unificada para leer y escribir datos geoespaciales mediante GDAL, realizar operaciones con geometrías mediante GEOS y efectuar transformaciones entre sistemas de coordenadas mediante PROJ.

En sf, los conjuntos de datos geoespaciales se almacenan en un data frame que contiene una columna especial para las geometrías. Esta columna se denomina generalmente ```geom``` o ```geometry```. El manejo de datos geoespaciales como data frames, permite manipularlos con las funciones ya desarrolladas para data frames y con la misma forma de referenciar las filas (observaciones) y las columnas (variables).

#### Ejemplos de uso de funciones
La función [st_read()](https://r-spatial.github.io/sf/reference/st_read.html) permite leer una fuenta de datos vectoriales (ej. archivo, base de datos) y recuperarlos en un [objeto sf](https://r-spatial.github.io/sf/reference/sf.html). Este tipo de objetos extiende los data frames con una columna de geometrías.

```{r}
# Lectura de una capa vectorial mediante st_read()
provincias <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_provincias_simp_wgs84.geojson",
    quiet = TRUE
  )
```

La función [plot()](https://r-spatial.github.io/sf/reference/plot.html) muestra un objeto sf en un mapa. 

```{r}
# Mapeo de un objeto sf mediante plot()
plot(provincias$geometry)

# Mapeo de un objeto sf con argumentos adicionales de plot()
plot(
  provincias$geometry,
  extent = st_bbox(c(
    xmin = -86,
    xmax = -82,
    ymax = 12,
    ymin = 8
  )),
  main = "Provincias de Costa Rica",
  axes = TRUE,
  graticule = TRUE
)
```

```st_read()``` puede leer datos de varios formatos.

```{r}
# Lectura de una archivo CSV con columnas de coordenadas mediante st_read()
registros_manigordos <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/gbif/leopardus_pardalis-cr-registros.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude",
      "Y_POSSIBLE_NAMES=decimalLatitude"
    ),
    quiet = TRUE
  )

# Asignación del sistema de coordenadas
st_crs(registros_manigordos) = 4326

# Mapeo
plot(
  registros_manigordos$geometry,
  extent = st_bbox(c(
    xmin = -86,
    xmax = -82,
    ymax = 12,
    ymin = 8
  )),
  main = "Registros de Leopardus pardalis (manigordo) en Costa Rica",
  col = "orange",
  axes = TRUE,
  graticule = TRUE
)
```

Los argumentos ```reset``` y ```add``` de la función ```plot()``` permiten construir un mapa con varias capas.

```{r}
# Primera capa del mapa
plot(
  provincias$geometry,
  extent = st_bbox(c(
    xmin = -86,
    xmax = -82,
    ymax = 12,
    ymin = 8
  )),
  main = "Distribución de Leopardus pardalis (manigordo) en Costa Rica",
  reset = FALSE,
  axes = TRUE,
  graticule = TRUE
)

# Segunda capa
plot(registros_manigordos,
     add = TRUE,
     col = "orange")
```

La función [st_write()](https://r-spatial.github.io/sf/reference/st_write.html) guarda en el disco un objeto sf. Pueden utilizarse los [formatos vectoriales de GDAL](https://gdal.org/drivers/vector/).

```{r eval=FALSE}
# Especificación del directorio de trabajo (debe ser una ruta existente)
setwd("C:/Users/mfvargas/Downloads")

# Se guarda la capa de provincias
provincias %>%
  st_write("provincias.shp")

# Se guarda la capa de registros de manigordos
registros_manigordos %>%
  st_write("registros_manigordos.kml")
```

#### Mapeo de objetos sf con otros paquetes

##### ggplot2

```{r}
ggplot(data = provincias) +
  geom_sf() +
  geom_point(
    data = registros_manigordos,
    aes(x = decimalLongitude, y = decimalLatitude),
    size = 2,
    col = "orange",
    fill = "orange"
  ) +
  coord_sf(xlim = c(-86, -82),
           ylim = c(8, 12),
           expand = FALSE) +
  ggtitle("Distribución de Leopardus pardalis (manigordo) en Costa Rica") +
  xlab("Longitud") +
  ylab("Latitud")
```

##### leaflet

```{r}
leaflet() %>%
  addTiles() %>%
  addPolygons(
    data = provincias,
    color = "black",
    fillColor = "transparent",
    stroke = TRUE,
    weight = 1.0,
  ) %>%
  addCircleMarkers(
    data = registros_manigordos,
    stroke = F,
    radius = 4,
    fillColor = 'orange',
    fillOpacity = 1
  )
```