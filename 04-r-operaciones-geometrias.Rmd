---
title: "Operaciones con geometrias"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparativos

## Carga de paquetes

```{r message = FALSE}
library(sf)
library(raster)
library(dplyr)
library(spData)

library(rmapshaper)
```

## Conjuntos de datos utilizados
 
```{r}
# Carga de la capa de provincias
provincias <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_provincias_simp_wgs84.geojson",
    quiet = TRUE
  )

# Carga de la capa de cantones
cantones <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_cantones_simp_wgs84.geojson",
    quiet = TRUE
  )

# Carga de la capa de mamíferos
mamiferos <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/gbif/mammalia-cr-registros.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude",
      "Y_POSSIBLE_NAMES=decimalLatitude"
    ),
    quiet = TRUE
  )

# Asignación del sistema de coordenadas
st_crs(mamiferos) <- 4326
```

# Introducción
Esta lección brinda una visión general de las operaciones con geometrías en datos vectoriales implementadas en el paquete [sf](https://r-spatial.github.io/sf/) y en datos raster implementadas en el paquete [raster](https://rspatial.org/raster). Estas operaciones trabajan con la columna de geometrías (ej. ```geometry```, ```geom```) del paquete ```sf```, para el caso de los datos vectoriales, y con la localización geográfica de los pixeles para el caso de los datos raster.

# Datos vectoriales
Las operaciones con geometrías en datos vectoriales incluyen:

- Simplificación.  
- Centroides. 
- Áreas de amortiguamiento (_buffers_).  
- Recortes (_clipping_).  

## Operaciones con geometrías con el paquete sf
Estas operaciones modifican las geometrías de objetos vectoriales (```sf```).

### Simplificación
La simplificación puede realizarse en geometrías de líneas y polígonos. Reduce la cantidad de memoria, disco y ancho de banda que utilizan las geometrías. Para simplificar geometrías, ```sf``` incluye el método [st_simplify](https://r-spatial.github.io/sf/reference/geos_unary.html), basado en el algoritmo de Douglas-Peucker, el cual recibe el argumento ```dTolerance``` para controlar el nivel de generalización de las unidades del mapa. Este argumento se expresa en las unidades de medida del CRS de la capa, por lo que es conveniente utilizar un CRS con unidades de medida de distancias (ej. metros).

```{r collapse=TRUE}
# Conversión de la capa de provincias a CRTM05 (unidad de medida = metros)
provincias <-
  provincias %>%
  st_transform(crs = 5367)

# Mapa de la capa de provincias sin simplificación
plot(
  provincias$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (geometrías no simplificadas)",
  axes = TRUE,
  graticule = TRUE
)

# Simplificación sin preservación de topología
provincias_simp <-
  provincias %>%
  st_simplify(dTolerance = 5000, preserveTopology = FALSE)

# Mapa de la capa de provincias con simplificación y sin preservación de topología
plot(
  provincias_simp$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas sin preservación de topología)",
  axes = TRUE,
  graticule = TRUE
)

# Simplificación con preservación de topología
provincias_simp_topo <-
  provincias %>%
  st_simplify(dTolerance = 5000, preserveTopology = TRUE)

# Mapa de la capa de provincias con simplificación y con preservación de topología
plot(
  provincias_simp_topo$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas con preservación de topología)",
  axes = TRUE,
  graticule = TRUE
)

# Tamaño de la capa original
object.size(provincias)

# Tamaño de la capa simplificada sin preservación de topología
object.size(provincias_simp)

# Tamaño de la capa simplificada con preservación de topología
object.size(provincias_simp_topo)
```

La función [rmapshaper::ms_simplify()](https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html) proporciona un método alternativo para la simplificación de geometrías.

```{r collapse=TRUE}
# Simplificación con rmapshaper::ms_simplify()
provincias_simp <-
  provincias %>%
  ms_simplify(keep = 0.1, keep_shapes = TRUE)

# Mapa de la capa de provincias con simplificación mediante rmapshaper::ms_simplify()
plot(
  provincias_simp$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas con rmapshaper::ms_simplify())",
  axes = TRUE,
  graticule = TRUE
)
```