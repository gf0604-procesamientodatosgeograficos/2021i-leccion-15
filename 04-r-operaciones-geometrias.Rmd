---
title: "Operaciones con geometrias"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparativos

## Carga de paquetes

```{r message = FALSE}
library(sf)
library(raster)
library(dplyr)
library(spData)

library(rmapshaper)
```

## Conjuntos de datos utilizados
 
```{r}
# Carga de la capa de provincias
provincias <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_provincias_simp_wgs84.geojson",
    quiet = TRUE
  )

# Carga de la capa de áreas silvestres protegidas (ASP)
asp <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/sinac/asp/asp-wgs84.geojson",
    quiet = TRUE
  )

# Carga de la capa de red vial
red_vial <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/red-vial/cr-redvial-simp-wgs84.geojson",
    quiet = TRUE
  )

# Carga de la capa de mamíferos
mamiferos <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/gbif/mammalia-cr-registros.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude",
      "Y_POSSIBLE_NAMES=decimalLatitude"
    ),
    quiet = TRUE
  )

# Asignación del sistema de coordenadas
st_crs(mamiferos) <- 4326
```

# Introducción
Esta lección brinda una visión general de las operaciones con geometrías en datos vectoriales implementadas en el paquete [sf](https://r-spatial.github.io/sf/) y en datos raster implementadas en el paquete [raster](https://rspatial.org/raster). Estas operaciones trabajan con la columna de geometrías (ej. ```geometry```, ```geom```) del paquete ```sf```, para el caso de los datos vectoriales, y con la localización geográfica de los pixeles para el caso de los datos raster.

# Datos vectoriales
Las operaciones con geometrías en datos vectoriales incluyen:

- Simplificación.  
- Centroides. 
- Áreas de amortiguamiento (_buffers_).  
- Recortes (_clipping_).  

## Operaciones con geometrías con el paquete sf
Estas operaciones modifican las geometrías de objetos vectoriales (```sf```).

### Simplificación
La simplificación puede realizarse en geometrías de líneas y polígonos. Reduce la cantidad de memoria, disco y ancho de banda que utilizan las geometrías. Para simplificar geometrías, ```sf``` incluye el método [st_simplify](https://r-spatial.github.io/sf/reference/geos_unary.html), basado en el algoritmo de Douglas-Peucker, el cual recibe el argumento ```dTolerance``` para controlar el nivel de generalización de las unidades del mapa. Este argumento se expresa en las unidades de medida del CRS de la capa, por lo que es conveniente utilizar un CRS con unidades de medida de distancias (ej. metros).

```{r collapse=TRUE}
# Conversión de la capa de provincias a CRTM05 (unidad de medida = metros)
provincias <-
  provincias %>%
  st_transform(crs = 5367)

# Mapa de la capa de provincias sin simplificación
plot(
  provincias$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (geometrías no simplificadas)",
  axes = TRUE,
  graticule = TRUE)

# Simplificación sin preservación de topología
provincias_simp <-
  provincias %>%
  st_simplify(dTolerance = 5000, preserveTopology = FALSE)

# Mapa de la capa de provincias con simplificación y sin preservación de topología
plot(
  provincias_simp$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas sin preservación de topología)",
  axes = TRUE,
  graticule = TRUE)

# Simplificación con preservación de topología
provincias_simp_topo <-
  provincias %>%
  st_simplify(dTolerance = 5000, preserveTopology = TRUE)

# Mapa de la capa de provincias con simplificación y con preservación de topología
plot(
  provincias_simp_topo$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas con preservación de topología)",
  axes = TRUE,
  graticule = TRUE)

# Tamaño de la capa original
object.size(provincias)

# Tamaño de la capa simplificada sin preservación de topología
object.size(provincias_simp)

# Tamaño de la capa simplificada con preservación de topología
object.size(provincias_simp_topo)
```

La función [rmapshaper::ms_simplify()](https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html) proporciona un método alternativo para la simplificación de geometrías, el cual preserva la topología.

```{r collapse=TRUE}
# Simplificación con rmapshaper::ms_simplify()
provincias_simp <-
  provincias %>%
  rmapshaper::ms_simplify(keep = 0.1, keep_shapes = TRUE)

# Mapa de la capa de provincias con simplificación mediante rmapshaper::ms_simplify()
plot(
  provincias_simp$geometry,
  extent = extent(280000, 660000, 880000, 1250000),  
  main = "Provincias (simplificadas con rmapshaper::ms_simplify())",
  axes = TRUE,
  graticule = TRUE)

# Tamaño de la capa simplificada con rmapshaper::ms_simplify()
object.size(provincias_simp)
```

### Centroides
Un centroide es un punto que identifica el centro de un objeto geográfico. Puede calcularse para geometrías de líneas y de polígonos y se utilizan para brindar una representación simplificada de geometrías más complejas. Existen varios métodos para calcularlos. 

El paquete  ```sf```  incluye la función [st_centroid()](https://r-spatial.github.io/sf/reference/geos_unary.html) la cual calcula el *centroide geográfico* (comúnmente llamado "el centroide"). Es posible que el centroide geográfico se ubique fuera de la geometría "padre" (ej. en una con forma de rosca). Para evitar este resultado, la función [st_point_on_surface()](https://r-spatial.github.io/sf/reference/geos_unary.html) se asegura de que el centroide esté siempre dentro de la geometría "padre".

```{r collapse=TRUE}
# Costa Rica y sus centroides calculados con st_centroid() y st_point_on_surface()
plot(
  st_union(provincias),
  main = "Costa Rica centroides st_centroid (rojo) st_point_on_surface (verde)",
  axes = TRUE,
  graticule = TRUE)

plot(st_centroid(st_union(provincias)),
     add = TRUE,
     pch = 16,
     col = "red")

plot(
  st_point_on_surface(st_union(provincias)),
  add = TRUE,
  pch = 16,
  col = "green")

# Coordenadas del centroide calculado con st_centroid()
# CRTM05
st_coordinates(st_centroid(st_union(provincias)))
# WGS84
st_coordinates(st_transform(st_centroid(st_union(provincias)), crs = 4326))

# Coordenadas del centroide calculado con st_point_on_surface()
# CRTM05
st_coordinates(st_point_on_surface(st_union(provincias)))
# WGS84
st_coordinates(st_transform(st_point_on_surface(st_union(provincias)), crs = 4326))


# Provincias de Costa Rica y sus centroides calculados con st_centroid() y st_point_on_surface()
plot(
  provincias$geometry,
  extent = extent(280000, 660000, 880000, 1250000),    
  main = "Provincias centroides st_centroid (rojo) st_point_on_surface (verde)",
  axes = TRUE,
  graticule = TRUE)

plot(st_centroid(provincias),
     add = TRUE,
     pch = 16,
     col = "red")

plot(
  st_point_on_surface(provincias),
  add = TRUE,
  pch = 16,
  col = "green")


# Ruta 32 y sus centroides calculados con st_centroid() y st_point_on_surface()
plot(
  provincias$geometry,
  extent = extent(280000, 660000, 880000, 1250000),    
  main = "Ruta 32 y centroides st_centroid (rojo) y st_point_on_surface (verde)",
  axes = TRUE,
  graticule = TRUE)

ruta_32 <-
  red_vial %>%
  filter(num_ruta == "32") %>%
  st_transform(crs = 5367)

plot(
  ruta_32$geometry,
  add = TRUE,
  col = "blue")

plot(
  st_centroid(st_union(ruta_32)),
  add = TRUE,
  pch = 16,
  col = "red")

plot(
  st_point_on_surface(st_union(ruta_32)),
  add = TRUE,
  pch = 16,
  col = "green")
```

### Áreas de amortiguamiento (*buffers*)
Los *buffers* son polígonos creados alrededor de otra geometría, ya sea otro polígono, una línea o un punto. El paquete ```sf``` incluye la función [st_buffer()]() para la generación de *buffers*.

```{r collapse=TRUE}
# Buffer alrededor de la ruta 32
plot(
  st_buffer(st_union(ruta_32), 5000),
  main = "Buffer alrededor de la ruta 32",
  axes = TRUE,
  graticule = TRUE)

plot(
  ruta_32$geometry,
  col = "blue",
  add = TRUE
)
```

Es común el uso de *buffers* en análisis de datos, para responder preguntas como, por ejemplo, "¿cuántos puntos hay alrededor de una línea?" o "¿cuáles especies pueden encontrarse en las márgenes de un río?".

```{r collapse=TRUE}
# Registros de presencia de mamíferos terrestres ubicados alrededor de la ruta 32
mamiferos <-
  mamiferos %>%
  filter(order != "Chiroptera") %>% # se excluye el orden de los murciélagos
  st_transform(crs = 5367)

buffer_ruta_32 <-
  ruta_32 %>%
  st_buffer(dist = 5000)

mamiferos_buffer_ruta_32 <-
  st_join(mamiferos, buffer_ruta_32) %>%
  filter(!is.na(codigo))

plot(
  st_union(buffer_ruta_32),
  main = "Mamíferos terrestres alrededor de la ruta 32",
  axes = TRUE,
  graticule = TRUE
)

plot(ruta_32$geometry,
     col = "blue",
     add = TRUE)

plot(
  mamiferos_buffer_ruta_32,
  pch = 16,
  col = "orange",
  add = TRUE
)

# 10 especies con mayor cantidad de registros
mamiferos_buffer_ruta_32 %>% 
  st_drop_geometry() %>%
  filter(!is.na(species) & species != "") %>%
  group_by(species) %>% 
  summarise(registros = n()) %>%
  arrange(desc(registros)) %>%
  slice(1:10)
```

### Recortes (*clipping*)

```{r collapse=TRUE}
# Recorte de la sección del Parque Internacional La Amistad (PILA) ubicada en Puntarenas
pila <-
  asp %>%
  filter(nombre_asp == "Internacional La Amistad") %>%
  st_transform(crs = 5367)

puntarenas_limon <-
  provincias %>%
  filter(provincia == "Puntarenas" | provincia == "Limón")

# Mapa de Puntarenas, Limón y el PILA
plot(
  puntarenas_limon$geometry,
  main = "Puntarenas, Limón y el PILA",
  extent = extent(350000, 660000, 880000, 1200000),
  axes = TRUE,
  graticule = TRUE)

plot(
  pila$geometry,
  border = "green",
  add = TRUE)

puntarenas <-
  provincias %>%
  filter(provincia == "Puntarenas")

# Recorte de la sección del PILA ubicada en Puntarenas
pila_puntarenas <- st_intersection(pila, puntarenas)

# Mapa de la sección recortada
plot(
  pila_puntarenas$geometry,
  main = "Sección del PILA ubicada en Puntarenas",
  col = "red",
  axes = TRUE,
  graticule = TRUE)

plot(
  puntarenas_limon$geometry,
  add = TRUE
)
```